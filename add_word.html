<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title></title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

</head>

<body>
  <div class="container">
    <br><br>
    <h1>ADD WORD</h1>
    <br><br>
    <div class="row justify-content-center">
      <form>
        <input type="file" class="form-control-file" name="image" value="">
        <br>
        <input type="text" class="form-control form-control-lg" name="vocab" value="">
        <br>
        <button class="btn btn-success" type="button" onclick="submitOnClick()">ADD</button>
      </form>
    </div>
  </div>
</body>
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<script src="/scripts/firebase-init.js"></script>
<script>

  $(function() {
    getLocation();
  });

  var position_latitude = '';
  var position_longitude = '';
  var image_path = '';

  function submitOnClick() {
    console.log("on click submit");
    var getImage = $('input[name="image"]').val();
    var getVocal = $('input[name="vocab"]').val();
    // File or Blob named mountains.jpg
    var file = $('input[name="image"]').get(0).files.item(0);

    uploadImage(file).then(function() {
      insertData('USER01', getVocal, image_path, position_latitude, position_longitude);
    });

  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        position_latitude = position.coords.latitude;
        position_longitude = position.coords.longitude;
      });
    } else {
      x.innerHTML = "Geolocation is not supported by this browser.";
    }
  }

  function uploadImage(file) {
    return new Promise(function(path) {

    // Create a root reference
    var storageRef = firebase.storage().ref('vocabularies');

    // Create the file metadata
    var metadata = {
      contentType: 'image/jpeg'
    };

    // Upload file and metadata to the object 'images/mountains.jpg'
    var uploadTask = storageRef.child(file.name).put(file, metadata);

    // Listen for state changes, errors, and completion of the upload.
    uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
      function(snapshot) {
        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log('Upload is ' + progress + '% done');
        switch (snapshot.state) {
          case firebase.storage.TaskState.PAUSED: // or 'paused'
            console.log('Upload is paused');
            break;
            2
          case firebase.storage.TaskState.RUNNING: // or 'running'
            console.log('Upload is running');
            break;
        }
      },
      function(error) {
        // A full list of error codes is available at
        // https://firebase.google.com/docs/storage/web/handle-errors
        switch (error.code) {
          case 'storage/unauthorized':
            // User doesn't have permission to access the object
            break;
          case 'storage/canceled':
            // User canceled the upload
            break;
          case 'storage/unknown':
            // Unknown error occurred, inspect error.serverResponse
            break;
        }
      },
      function() {
        // Upload completed successfully, now we can get the download URL
        var downloadURL = uploadTask.snapshot.downloadURL;
        console.log(downloadURL);
        image_path = downloadURL;
        path(downloadURL);
      });
    });
  }

  function insertData(user, vocab, image, latitude, longitude) {
    var firebaseRef = firebase.database().ref("words");
    firebaseRef.push({
      user: user,
      vocab: vocab,
      image: image,
      latitude: latitude,
      longitude: longitude
    });
    console.log("Insert Success!");
  }
</script>

</html>
